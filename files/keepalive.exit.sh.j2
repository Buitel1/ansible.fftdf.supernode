#!/bin/bash
echo 0 > /tmp/sn_online
$BATCTL gw off
/usr/sbin/service bird6 stop
/usr/sbin/service bird stop
/usr/sbin/service tunneldigger stop
/usr/sbin/service radvd stop
/usr/sbin/service isc-dhcp-server stop
while [ true ] ; do
	online=$(/bin/cat /tmp/sn_online)
	iam=$(/bin/hostname)
	day=$(date +%d)
	BATCTL=/usr/local/sbin/batctl
	#### Settings ####
	# Names of the 2 Supernodes #
	SN1=troisdorf5
	SN2=troisdorf6
	# Default Supernode if loadbalance=0 or day > 15 #
	active_SN=$SN2
	# Turn loadbalance on/off #
	loadbalance=1
	##################
	# functions #
	# Supernode off #
	supernode_off () {
	    $BATCTL gw off
		/usr/sbin/service bird6 stop
		/usr/sbin/service bird stop
		/usr/sbin/service tunneldigger stop
		/usr/sbin/service radvd stop
		/usr/sbin/service isc-dhcp-server stop
		echo 0 > /tmp/sn_online
		echo "collectd.gateways.{{ sn_hostname }}.sn-status $online `date +%s`" | nc -q 0 10.188.1.27 2003
	}
	# Supernode on #
	supernode_on () {
		$BATCTL gw server 100Mbit/100Mbit
	    /usr/sbin/service bird6 start
	    /usr/sbin/service bird start
	    /usr/sbin/service tunneldigger start
	    /usr/sbin/service radvd start
	    /usr/sbin/service isc-dhcp-server start
	    echo 1 > /tmp/sn_online
	    echo "collectd.gateways.{{ sn_hostname }}.sn-status $online `date +%s`" | nc -q 0 10.188.1.27 2003
	}
	# Restart Services #
	supernode_fail () {
		$BATCTL gw off
		/usr/sbin/service bird6 restart
		/usr/sbin/service bird restart
		/usr/sbin/service tunneldigger restart
		/usr/sbin/service radvd restart
		/usr/sbin/service isc-dhcp-server restart
		echo 0 > /tmp/sn_online	
		echo "collectd.gateways.{{ sn_hostname }}.sn-status $online `date +%s`" | nc -q 0 10.188.1.27 2003
	}
 	# who am i ? #
	if [ $iam == troisdorf5 ]
	then
		my_SN_IP=185.66.193.105
		other_SN_IP=185.66.193.106
		other_SN_IP_EXTERN=46.4.138.189
	else
		my_SN_IP=185.66.193.106
		other_SN_IP=185.66.193.105
		other_SN_IP_EXTERN=5.9.76.198
	fi
	if [ $loadbalance == 1 ] 
	then
		if [ $day -gt 15 ] 
		then
			active_SN=$SN1
		fi
	fi
	#Check other Supernode
	if [ $iam != $active_SN ] 
	then
		ping -q -c5 $other_SN_IP -I eth0 > /dev/null
		if [ $? -eq 0 ] 
		then
	    	if [ $online == 1 ]; then
	    		curl -X POST --data-urlencode 'payload={"text": "Aktiver Supernode wieder online. Ich habe mich wieder ausgeschaltet", "channel": "#technik", "username": "{{ sn_hostname }}", "icon_emoji": ":white_check_mark:"}' https://hooks.slack.com/services/{{ slack_token }}
	    	fi
	    	supernode_off
		else
			supernode_on
			curl -X POST --data-urlencode 'payload={"text": "Aktiver Supernode offline. Ich habe mich eingeschaltet", "channel": "#technik", "username": "{{ sn_hostname }}", "icon_emoji": ":warning:"}' https://hooks.slack.com/services/{{ slack_token }}
			sleep 300
		fi
	else
		# Check this Supernode
		ping -q -c5 $my_SN_IP -I eth0 > /dev/null
		if [ $? -eq 0 ] 
		then
		    if [ $online == 0 ]; then
		    	curl -X POST --data-urlencode 'payload={"text": "Ich bin jetzt Supernode!", "channel": "#technik", "username": "{{ sn_hostname }}", "icon_emoji": ":white_check_mark:"}' https://hooks.slack.com/services/{{ slack_token }}
		    fi
		    supernode_on
		else
			supernode_fail
			curl -X POST --data-urlencode 'payload={"text": "Ich konnte mich selbst nicht anpingen. Ich versuche mal die Services neu zu starten", "channel": "#technik", "username": "{{ sn_hostname }}", "icon_emoji": ":warning:"}' https://hooks.slack.com/services/{{ slack_token }}
		fi
	fi
	for service in bird bird6 isc-dhcp-server radvd python named
    do
        x=`pidof $service`;
        if [ "$x" == "" ]; then 
                echo "collectd.gateways.{{ sn_hostname }}.$service 0 `date +%s`" | nc -q 0 10.188.1.27 2003
        else
                echo "collectd.gateways.{{ sn_hostname }}.$service 1 `date +%s`" | nc -q 0 10.188.1.27 2003
        fi
    done
	sleep 60
done
